# Payment integration

## Table of Contents:

- [Payment integration](#payment-integration)
  - [Table of Contents:](#table-of-contents)
  - [Postponed](#postponed)
  - [Changes required as of 2020-09-10](#changes-required-as-of-2020-09-10)

---

## Postponed

- Provider-location:
  - if added to a New York pharmacy, add NY specific questions also
- Feed
  - enable PCR Test for SIE
- Scheduling page
  - if the appointment requires payment, the button needs to indicate payment:
    "Pay"? "Buy"? "Purchase Appointment"? Show Amount
- Confirmation Service
  - update entitlements in the membership record itself
  - also cancel the booking if payment is canceled
- Booking
  - if a pending payment session already exists, what to do?
  - if a pending appointment already exists, do we let them buy another?
- Stripe
  - create separate product for each Pharmacy?

## Changes required as of 2020-09-10

- Membership (person)

  - We will create a new Membership for a person's "CASH" purchases

    - All CASH memberships will be individual, with PersonCode 01

  - Need to generate primaryMemberFamilyId.

    - Prefer it to not be sequential

  - Example

    ```json
    {
      "carrierPCN": "PH",
      "rxBin": "610749",
      "rxGroup": "A9002451",
      "rxSubGroup": "CASH01",
      "rxGroupType": "CASH",
      "effectiveDate": "20200301",

      "phoneNumber": "",
      "firstName": "JOE",
      "lastName": "BLOW",
      "dateOfBirth": ISODate("1955-11-16T00:00:00.000+0000"),

      "primaryMemberRxId": "PHX1000101",
      "primaryMemberFamilyId": "PHX10001",
      "primaryMemberPersonCode": "01",

      "identifier": "xxxx",
      "isPrimary": true,
      "isPhoneNumberVerified": true,
      "email": "",

      "isRxAssistantOnboarded": true
    }
    ```

- Provider-location:

  - Add PCR Test service definition
  - Make sure questions in the CQuentia Order data CSV match what we need to
    send
  - Add service to the Sample Pharmacies for testing
  - Design "payment" configuration within the service, with the data Stripe
    needs
  - accept the serviceType parameter and filter ProviderLocation
    - (Previously its hardcoded to serviceType.antigen)

- Feed

  - Cards

    - "Schedule PCR Test"
      - data: exclude SIE (for this sprint)
      - when clicked, pass the serviceType to the Start Testing page
      - pass serviceType to the terms and conditions
      - pass serviceType to pharmacy list and send it to the API to filter the
        ProviderLocations
    - "Test Result" specific to member/account (memberRxId)
      - component: needs to pass the id to the Test result screen
      - data: needs to contain the context info for the specific test result (so
        we dont just return the latest one)
    - "Appointment/Receipt" for PCR Test - specific to member (memberRxId)

      - data: need id for the booking
      - component: clicking should redirect to the confirmation page with the
        current booking info (call api/appointment/[id])

    - "Add Membership"

      - component: in progress
      - data: exclude rxGroupType=SIE

  - API

    - Add FeedProvider model to inject "cards" based on different rules
      - MembershipFeedProvider
      - OffersFeedProvider
      - FeedCollectionFeedProvider
      - AppointmentsFeedProvider
      - TestResultsFeedProvider
      - ClaimAlertsFeedProvider

- Consent page

  - accept serviceType and choose the correct consent content

- Confirmation screen

  - deep link to the appointment confirmation

    - provide as SUCCESS_URL and a CANCEL_URL in call to stripe
    - /checkout/[session-id]/confirm
    - /checkout/[session-id]/cancel

  - update confirmation screen with the payment receipt, order number, etc

    - if canceled, show it was canceled?
    - if payment confirmed, show receipt

  - Confirmation Service

    - move current service bus message handlers from existing service into new
      Confirmation service
    - move the code that sends the SMS
    - receive new stripe msg when purchase is complete/canceled
      - [see stripe webhook]
    - updates the appointment HealthEvent status to paid
    - if payment was required, make sure payment is complete before sending SMS

- MyRx API

  - create appointment: `/api/provider-location/create-booking`

    - Payment is required if service.payment exists
    - call must include person details if no existing "cash" membership
    - if "service" to be booked does not require payment, continues as-is
    - if payment required
      - call stripe API to create a "session"
        - stripe/session
      - return payment redirect link in response
    - if "cash" membership did not exist, then send new membership to
      PersonUpdate service (see data tasks above)
    - get stripe API code here: -
      https://github.com/stripe-samples/checkout-one-time-payments/blob/master/client-and-server/server/node/server.js

  - get appointment: `GET /api/appointment/[id]`
    - return appointment info for the confirmation page

- Stripe

  - register webhook for the official response from stripe create checkout
    session for the PCR test

    - configure in API Management to convert webhook to service bus message
    - appointment confirmation needs to wait for both the stripe webhook to
      finish, and the appointment to be confirmed

  - Products are registered

    - a Product Price is registered for each Pharmacy

      - Stripe.Product.Price.id is assigned as the "productKey" under "payment"
        object:

      ```json
          {
            "serviceId": "113",
            "serviceHashId": "aMqjTdUudSTtO6gHdgw2",
            "serviceName": "COVID-19 PCR Testing",
            "serviceType": "COVID-19 PCR Testing",
            //...
            "payment": {
              "productKey": "stripe.product.price.id"
            },
            "questions": [],
            "duration": NumberInt(30),
            "testingTime": NumberInt(20),
            "bufferTime": NumberInt(10),
            "minLeadDays": "P1D",
            "maxLeadDays": "P30D",
            "staffMembers": [],
            "resources": []
          }
        ],
        "workingHours": []
      }
      ```
