FROM mhart/alpine-node:slim-14

# required ENV or .env file settings (should be set during release):
ENV ACCOUNT_TOKEN_EXPIRES_IN=1800
ENV CHILD_MEMBER_AGE_LIMIT=13
ENV DEVICE_TOKEN_EXPIRES_IN=31536000
ENV JWT_TOKEN_EXPIRES_IN=31536000
ENV MAX_PIN_VERIFICATION_ATTEMPTS=5
ENV PORT=4300
ENV REDIS_DEVICE_TOKEN_KEY_EXPIRES_IN=31536000
ENV REDIS_PHONE_NUMBER_REGISTRATION_KEY_EXPIRES_IN=1800
ENV REDIS_PERSON_CREATE_KEY_EXPIRES_IN=1800
ENV REDIS_PIN_KEY_EXPIRES_IN=1800
ENV REDIS_PIN_VERIFICATION_KEY_EXPIRES_IN=3600
ENV REDIS_PORT=6380
ENV REDIS_PIN_RESET_SCAN_DELETE_COUNT=1000

ENV TOPIC_NAME_UPDATE_ACCOUNT="topic-account-update"
ENV TOPIC_NAME_UPDATE_PERSON="topic-person-update"
ENV TOPIC_NAME_UPDATE_HEALTH_RECORD_EVENT="topic-health-record-event-update"
ENV WINSTON_LOG_FILE_PATH="/var/log/prescryptive-logs/winston.log"
ENV TOPIC_NAME_APPOINTMENT_CANCELLED_EVENT="topic-appointment-cancellation-requested"
ENV TOPIC_NAME_COMMON_BUSINESS_EVENT="topic-common-business-event"
ENV TOPIC_NAME_COMMON_MONITORING_EVENT="topic-common-monitoring-event"

ENV APPINSIGHTS_INSTRUMENTATION_KEY="<APPINSIGHTS_INSTRUMENTATION_KEY_MISSING>"
ENV CERTIFICATE_PFX_FILE="<CERTIFICATE_PFX_FILE_MISSING>"
ENV CERTIFICATE_PFX_PASS="<CERTIFICATE_PFX_PASS_MISSING>"
ENV DATABASE_CONNECTION="<DATABASE_CONNECTION_MISSING>"
ENV GUESTMEMBEREXPERIENCE_CORS_HOSTS="<GUESTMEMBEREXPERIENCE_CORS_HOSTS_MISSING>"
ENV HEALTHBOT_APP_SECRET="<HEALTHBOT_APP_SECRET_MISSING>"
ENV HEALTHBOT_WEBCHAT_SECRET="<HEALTHBOT_WEBCHAT_SECRET_MISSING>"
ENV JWT_TOKEN_SECRET_KEY="<JWT_TOKEN_SECRET_KEY_MISSING>"
ENV REDIS_AUTH_PASS="<REDIS_AUTH_PASS_MISSING>"
ENV REDIS_HOST="<REDIS_HOST_MISSING>"
ENV SERVICE_BUS_CONNECTION_STRING="<SERVICE_BUS_CONNECTION_STRING_MISSING>"
ENV TWILIO_ACCOUNT_SID="<TWILIO_ACCOUNT_SID_MISSING>"
ENV TWILIO_AUTH_TOKEN="<TWILIO_AUTH_TOKEN_MISSING>"
ENV TWILIO_VERIFICATION_SERVICE_ID="<TWILIO_VERIFICATION_SERVICE_ID_MISSING>"
ENV TWILIO_REMOVE_WAITLIST_URL="<TWILIO_REMOVE_WAITLIST_URL_MISSING>"
# setup user (non-root)
RUN mkdir -p /var/log/prescryptive-logs
RUN mkdir -p /var/appuser
RUN addgroup -g 1000 -S appuser
RUN adduser -u 1000 appuser -G appuser -S -D -h /var/appuser
ENV USER=appuser

# copy compiled script
WORKDIR /var/appuser
COPY --chown=appuser:appuser ./build /var/build/api

# switch user
USER appuser

# expose port
EXPOSE 4300

# set entrypoint
CMD ["node", "/var/build/api/index.js"]